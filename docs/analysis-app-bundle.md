# Analysis: App-BznLR4IR.js (Vite Production Bundle)

## Overview

`App-BznLR4IR.js` is the **main application entry bundle** produced by Vite 6 for the SkateHubba client. The hash suffix (`BznLR4IR`) is a content hash generated by Vite's Rollup-based build pipeline for long-term caching. This file is served from `https://skatehubba.com/assets/App-BznLR4IR.js`.

## Source-to-Bundle Mapping

The minified bundle corresponds to these source files:

| Bundle Symbol | Source File | Purpose |
|---|---|---|
| `App` (default export) | `client/src/App.tsx` | Root React component |
| `Se` / `apiRequestRaw` | `client/src/lib/api/client.ts` | HTTP fetch wrapper with auth, CSRF, timeout |
| `T` / `ApiError` | `client/src/lib/api/errors.ts` | Typed API error class with error codes |
| `La` / `queryClient` | `client/src/lib/queryClient.ts` | TanStack React Query client with retry logic |
| `$` / `dispatch`, `ie` / `useToast` | `client/src/hooks/use-toast.ts` | Global toast notification system |
| `AppRoutes` | `client/src/routes/AppRoutes.tsx` | Wouter-based route definitions |

## Bundle Dependency Map (`__vite__mapDeps`)

The `__vite__mapDeps` array at the top of the file lists **50 lazily-loaded chunks**. These are code-split modules loaded on demand via dynamic `import()`. Key chunks and their source pages:

| Chunk File | Source Module |
|---|---|
| `hub-m6AixtpW.js` | Hub dashboard (main authenticated view) |
| `play-DKLOUk3Y.js` | S.K.A.T.E. game play page |
| `me-CvPXx3ba.js` | User profile/settings page |
| `leaderboard-Du8gbCF5.js` | Rankings page |
| `map-D_ghdRNU.js` | Leaflet-based spot map |
| `SpotDetailPage-Aw1bl4a6.js` | Individual spot detail view |
| `trickmint-CXnhSnEz.js` | Video feed (TrickMint) |
| `tutorial-8cTm_W5N.js` | Tutorial system |
| `demo-BnpygzyV.js` | Demo mode |
| `login-DTa1NfRo.js` | Login page |
| `signup-Cko0Hd1o.js` | Sign-up page |
| `AdminDashboard-CtKgCRNs.js` | Admin panel |
| `profile-MEzxQb58.js` | Public profile page |

### Shared Vendor Chunks

| Chunk File | Contents |
|---|---|
| `vendor-BbmaKXis.js` | React 18, React DOM, TanStack React Query, Wouter |
| `index-CEfWY2NF.js` | App-level shared utilities, Firebase config |
| `radix-qJwWZYnL.js` | Radix UI primitives (dialog, dropdown, tooltip, etc.) |
| `icons-D7MzHfqT.js` | Lucide React icon components |
| `firebase-CJzuDbDQ.js` | Firebase Auth SDK, Firestore client |
| `motion-B08_we8w.js` | Framer Motion animation library |
| `leaflet-B5XJBGue.js` | Leaflet map library |

## Key Subsystems in the Bundle

### 1. API Client (`client/src/lib/api/client.ts`)

The API client (`apiRequestRaw` / minified as `Se`) handles all server communication:

- **Base URL resolution**: Dynamically selects API endpoint based on environment (`prod` -> `https://api.skatehubba.com`, `staging` -> `https://staging-api.skatehubba.com`, `local` -> `http://localhost:3001`)
- **Authentication**: Attaches Firebase ID token via `Authorization: Bearer <token>` header
- **CSRF protection**: Reads `csrfToken` cookie and sends it as `X-CSRF-Token` header on mutating requests
- **Timeout handling**: 30-second default timeout using `AbortController`
- **Error normalization**: Converts HTTP errors into typed `ApiError` instances with structured error codes

### 2. Error System (`client/src/lib/api/errors.ts`)

Custom `ApiError` class with 10 typed error codes:

| Code | Trigger | User-Facing Message |
|---|---|---|
| `RATE_LIMIT` | HTTP 429 or server code | "You're moving fast. Take a breather..." |
| `REPLAY_DETECTED` | Duplicate nonce | "We blocked a duplicate request." |
| `QUOTA_EXCEEDED` | Daily limit reached | "You've hit today's limit." |
| `BANNED` | Account restricted | "Your account is currently restricted." |
| `UNAUTHORIZED` | HTTP 401/403 | "Please sign in again to continue." |
| `VALIDATION_ERROR` | HTTP 400 or invalid input | "Double-check your info and try again." |
| `TOO_FAR` | Geo check-in distance exceeded | "You're ~Xm away (need to be within Ym)." |
| `TIMEOUT` | Request exceeded 30s | "The request took too long." |
| `NETWORK_ERROR` | Fetch failure (offline/CORS) | "Network error. Check your connection." |
| `UNKNOWN` | Unclassified errors | "Unexpected error. Please try again." |

### 3. Query Client (`client/src/lib/queryClient.ts`)

TanStack React Query configuration:

- **Retry policy**: Up to 3 retries for transient errors (network, timeout, 5xx). Never retries auth, validation, ban, or quota errors.
- **Backoff strategy**: Exponential backoff — rate limits up to 30s, network errors up to 15s, other errors up to 10s.
- **Caching**: `staleTime: Infinity` (data never auto-refetches), `refetchOnWindowFocus: false`.

### 4. Toast Notifications (`client/src/hooks/use-toast.ts`)

Lightweight pub/sub toast system:

- Single-toast limit (newest toast replaces old)
- Module-level state with listener pattern (not React context)
- Auto-removal after ~16 minutes (`TOAST_REMOVE_DELAY = 1000000ms`)

### 5. App Shell (`client/src/App.tsx`)

The root component wires together:

- `ErrorBoundary` — graceful crash recovery
- `MotionConfig` — respects `prefers-reduced-motion`
- `QueryClientProvider` — async state management
- `TooltipProvider` — accessible tooltips
- `Router` (Wouter) — lightweight client-side routing
- `StagingBanner` / `OfflineBanner` — environment indicators
- `PWAInstallPrompt` — progressive web app install
- `BuildStamp` — dev-only build metadata (hidden in production)
- Structured data (JSON-LD) for SEO

## Technology Stack Summary

| Category | Technology | Version |
|---|---|---|
| **Framework** | React | 18 |
| **Bundler** | Vite | 6 |
| **Router** | Wouter | latest |
| **State/Async** | TanStack React Query | v5 |
| **UI Components** | Radix UI + Shadcn/ui | latest |
| **Animation** | Framer Motion | latest |
| **Auth** | Firebase Auth | v10+ |
| **Maps** | Leaflet | 1.9 |
| **Icons** | Lucide React | latest |
| **Styling** | Tailwind CSS | 3.4 |

## Build Configuration

From `vite.config.ts`:

```typescript
{
  root: "client",
  build: {
    outDir: "../dist/public",
    sourcemap: false,       // No sourcemaps in production
    emptyOutDir: true,
  },
  envPrefix: ['VITE_', 'EXPO_PUBLIC_'],  // Shared env vars with mobile
  plugins: [react(), tsconfigPaths()],
}
```

Key decisions:
- **No production sourcemaps** — prevents reverse engineering and reduces bundle size
- **Dual env prefix** — allows sharing environment variables between web (Vite) and mobile (Expo)
- **Code splitting** — 50 lazy chunks via React.lazy + Suspense for optimal initial load

## Debugging Guide

### Network Panel Checklist

1. Verify `App-BznLR4IR.js` loads with HTTP 200 and correct `Content-Type: application/javascript`
2. Check that `vendor-BbmaKXis.js` and `index-CEfWY2NF.js` load before route-specific chunks
3. Confirm lazy chunks load on navigation (e.g., `hub-m6AixtpW.js` loads when visiting `/hub`)
4. Watch for 401/403 errors on API calls — indicates auth token issues

### Common Issues

| Symptom | Likely Cause | Fix |
|---|---|---|
| Blank page | Chunk load failure (deploy mismatch) | Hard refresh or clear cache |
| "Network error" toast | CORS blocked or offline | Check API CORS config, network |
| Infinite loading spinner | Auth state stuck | Check Firebase Auth initialization |
| Missing UI components | Radix chunk failed to load | Check `radix-qJwWZYnL.js` in network |
| Map not rendering | Leaflet chunk/CSS missing | Verify `leaflet-B5XJBGue.js` and `leaflet-Dgihpmma.css` |

### Performance Analysis

- **Critical path**: `vendor` + `index` + `App` bundles must load before any rendering
- **Route-based splitting**: Each page is a separate chunk, loaded on demand
- **Shared dependencies**: UI library (Radix), icons, and Firebase are in dedicated shared chunks to avoid duplication
