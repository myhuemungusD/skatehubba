name: Mobile E2E Tests

on:
  push:
    branches: [ main ]
    paths:
      - "mobile/**"
      - "packages/types/**"
      - "packages/shared/**"
  pull_request:
    paths:
      - "mobile/**"
      - "packages/types/**"
      - "packages/shared/**"
  workflow_dispatch:
  workflow_call:

jobs:
  detox_android:
    name: "Detox E2E (Android)"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    timeout-minutes: 45
    env:
      DETOX_CONFIGURATION: android.emu.debug
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-pnpm-env

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Write google-services.json for Firebase
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            printf '%s' "$GOOGLE_SERVICES_JSON" > google-services.json
          else
            cat > google-services.json << 'PLACEHOLDER'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "skatehubba-ci-placeholder",
              "storage_bucket": "skatehubba-ci-placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                "android_client_info": { "package_name": "com.skatehubba.app" }
              },
              "api_key": [{ "current_key": "ci-placeholder" }],
              "services": { "appinvite_service": { "other_platform_oauth_client": [] } }
            }],
            "configuration_version": "1"
          }
          PLACEHOLDER
          fi
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

      - name: Verify Detox installed
        run: |
          npx detox --version
          echo "Config file exists:"
          cat .detoxrc.json | head -5

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Enable KVM (for Android emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install emulator system dependencies
        run: sudo apt-get update && sudo apt-get install -y libpulse0

      - name: Ensure latest Android platform-tools and emulator
        run: |
          ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --update
          ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager "platform-tools" "emulator"

      - name: AVD Cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-test-api31-${{ runner.os }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: default
          arch: x86_64
          avd-name: test
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot-load
          emulator-boot-timeout: 600
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Expo Prebuild (Android)
        run: npx expo prebuild --platform android --no-install

      - name: Verify Android project
        run: |
          echo "android/ directory contents:"
          ls -la android/app/ || echo "ERROR: android/app/ does not exist"
          echo "gradlew exists:"
          test -f android/gradlew && echo "yes" || echo "no"

      - name: Pre-bundle JS for Android
        env:
          EXPO_PUBLIC_FIREBASE_API_KEY: ci-placeholder
          EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN: ci-placeholder.firebaseapp.com
          EXPO_PUBLIC_FIREBASE_PROJECT_ID: ci-placeholder
          EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET: ci-placeholder.appspot.com
          EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "000000000000"
          EXPO_PUBLIC_FIREBASE_APP_ID: "1:000000000000:android:0000000000000000"
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --entry-file index.js \
            --config metro.config.js \
            --dev false \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res/

      - name: Build Detox (Android)
        run: pnpm run e2e:build:android

      - name: Clean up adb and emulator processes
        run: |
          adb kill-server || true
          pkill -f emulator || true
          pkill -f qemu-system || true
          sleep 5

      - name: Remove AVD locks
        run: rm -rf ~/.android/avd/*.lock

      - name: Run Detox Tests (Android)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: default
          arch: x86_64
          avd-name: test
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off
          emulator-boot-timeout: 600
          disable-animations: true
          working-directory: mobile
          script: |
            timeout 300 bash -c 'until adb shell getprop sys.boot_completed | grep 1; do sleep 5; done'
            adb devices
            adb shell input keyevent 82
            sleep 2
            pnpm run e2e:test:android -- --loglevel verbose

      - name: Print adb state (debug)
        if: failure()
        run: |
          adb devices || true
          adb get-state || true

      - name: Upload Detox Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-android-artifacts
          path: mobile/artifacts/
          retention-days: 7

  detox_ios:
    name: "Detox E2E (iOS)"
    runs-on: macos-latest
    # Gate behind label or manual dispatch (macos runners are 10x cost vs ubuntu)
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'e2e')
    defaults:
      run:
        working-directory: mobile
    timeout-minutes: 60
    env:
      DETOX_CONFIGURATION: ios.sim.debug
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-pnpm-env

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: mobile/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('mobile/ios/Podfile.lock') }}
          restore-keys: ${{ runner.os }}-pods-

      - name: Create Firebase config files
        run: |
          if [ -n '${{ secrets.GOOGLE_SERVICES_JSON }}' ]; then
            echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > google-services.json
          else
            cat > google-services.json << 'GSEOF'
          {
            "project_info": { "project_number": "000000000000", "project_id": "skatehubba-placeholder", "storage_bucket": "skatehubba-placeholder.appspot.com" },
            "client": [{ "client_info": { "mobilesdk_app_id": "1:000000000000:android:0000000000000000", "android_client_info": { "package_name": "com.skatehubba.app" } }, "api_key": [{ "current_key": "placeholder" }], "services": {} }],
            "configuration_version": "1"
          }
          GSEOF
          fi
          if [ -n '${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}' ]; then
            echo '${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}' > GoogleService-Info.plist
          else
            cat > GoogleService-Info.plist << 'PEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>CLIENT_ID</key><string>placeholder</string>
            <key>REVERSED_CLIENT_ID</key><string>placeholder</string>
            <key>API_KEY</key><string>placeholder</string>
            <key>GCM_SENDER_ID</key><string>000000000000</string>
            <key>PLIST_VERSION</key><string>1</string>
            <key>BUNDLE_ID</key><string>com.skatehubba.app</string>
            <key>PROJECT_ID</key><string>skatehubba-placeholder</string>
            <key>STORAGE_BUCKET</key><string>skatehubba-placeholder.appspot.com</string>
            <key>IS_ADS_ENABLED</key><false/>
            <key>IS_ANALYTICS_ENABLED</key><false/>
            <key>IS_APPINVITE_ENABLED</key><false/>
            <key>IS_GCM_ENABLED</key><true/>
            <key>IS_SIGNIN_ENABLED</key><true/>
            <key>GOOGLE_APP_ID</key><string>1:000000000000:ios:0000000000000000</string>
          </dict></plist>
          PEOF
          fi

      - name: Install CocoaPods
        run: |
          if [ -d "ios" ]; then
            cd ios && pod install
          else
            echo "No ios directory â€” run 'npx expo prebuild' first"
            npx expo prebuild --platform ios --no-install
            cd ios && pod install
          fi

      - name: Boot iOS Simulator
        run: |
          DEVICE=$(xcrun simctl list devices available -j | \
            python3 -c "import sys,json; devs=json.load(sys.stdin)['devices']; print([d['udid'] for r in devs.values() for d in r if 'iPhone 15' in d['name']][0])")
          xcrun simctl boot "$DEVICE" || true

      - name: Build Detox
        run: pnpm run e2e:build:ios

      - name: Run Detox Tests
        run: pnpm run e2e:test:ios -- --headless

      - name: Upload Detox Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-ios-artifacts
          path: mobile/artifacts/
          retention-days: 7
