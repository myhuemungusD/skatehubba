name: Mobile E2E Tests

on:
  push:
    branches: [ main ]
    paths:
      - "mobile/**"
      - "packages/types/**"
      - "packages/shared/**"
  pull_request:
    paths:
      - "mobile/**"
      - "packages/types/**"
      - "packages/shared/**"
  workflow_dispatch:
  workflow_call:

jobs:
  detox_android:
    name: "Detox E2E (Android)"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    timeout-minutes: 45
    env:
      DETOX_CONFIGURATION: android.emu.debug
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-pnpm-env

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Write google-services.json for Firebase
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            printf '%s' "$GOOGLE_SERVICES_JSON" > google-services.json
          else
            cat > google-services.json << 'PLACEHOLDER'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "skatehubba-ci-placeholder",
              "storage_bucket": "skatehubba-ci-placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                "android_client_info": { "package_name": "com.skatehubba.app" }
              },
              "api_key": [{ "current_key": "ci-placeholder" }],
              "services": { "appinvite_service": { "other_platform_oauth_client": [] } }
            }],
            "configuration_version": "1"
          }
          PLACEHOLDER
          fi
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Enable KVM (for Android emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD Cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-pixel6-api34-${{ runner.os }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          avd-name: Pixel_6_API_34
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot-load
          emulator-boot-timeout: 300
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Expo Prebuild (Android)
        run: npx expo prebuild --platform android --no-install

      - name: Build and Run Detox Tests (Android)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          avd-name: Pixel_6_API_34
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot-load
          emulator-boot-timeout: 300
          disable-animations: true
          working-directory: mobile
          script: |
            adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
            sleep 5
            adb devices
            pnpm run e2e:build:android
            pnpm run e2e:test:android -- --headless

      - name: Upload Detox Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-android-artifacts
          path: mobile/artifacts/
          retention-days: 7

  detox_ios:
    name: "Detox E2E (iOS)"
    runs-on: macos-latest
    # Gate behind label or manual dispatch (macos runners are 10x cost vs ubuntu)
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'e2e')
    defaults:
      run:
        working-directory: mobile
    timeout-minutes: 60
    env:
      DETOX_CONFIGURATION: ios.sim.debug
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-pnpm-env

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: mobile/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('mobile/ios/Podfile.lock') }}
          restore-keys: ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: |
          if [ -d "ios" ]; then
            cd ios && pod install
          else
            echo "No ios directory â€” run 'npx expo prebuild' first"
            npx expo prebuild --platform ios --no-install
            cd ios && pod install
          fi

      - name: Boot iOS Simulator
        run: |
          DEVICE=$(xcrun simctl list devices available -j | \
            python3 -c "import sys,json; devs=json.load(sys.stdin)['devices']; print([d['udid'] for r in devs.values() for d in r if 'iPhone 15' in d['name']][0])")
          xcrun simctl boot "$DEVICE" || true

      - name: Build Detox
        run: pnpm run e2e:build:ios

      - name: Run Detox Tests
        run: pnpm run e2e:test:ios -- --headless

      - name: Upload Detox Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-ios-artifacts
          path: mobile/artifacts/
          retention-days: 7
